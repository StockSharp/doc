# Отфильтрованный стакан

Отфильтрованный стакан — это специализированный инструмент в StockSharp, позволяющий трейдерам и автоматизированным стратегиям оперировать на рынке, исключая из рассмотрения собственные заявки. Это критически важно при параллельном использовании нескольких стратегий, чтобы предотвратить ситуации, когда одна стратегия начинает "торговать" с другой, не осознавая, что объем в стакане идёт от другого участника торгов или же является результатом действий параллельно запущенной стратегии.

## Преимущества отфильтрованного стакана

- **Избегание самоторговли**: Стратегии не будут исполнять заявки против самих себя или друг друга при параллельном запуске.
- **Чистота анализа**: Позволяет стратегиям анализировать рыночные условия, основываясь исключительно на внешних заявках, без искажений, вызванных собственными заявками.
- **Эффективность исполнения**: Помогает улучшить качество исполнения заявок, минимизируя влияние на рыночную цену собственными заявками.

## Пример подписки

Для работы с отфильтрованным стаканом заявок используется тот же подход, что и при [подписке на обычный стакан](subscriptions.md), но с передачей другого значения [DataType](xref:StockSharp.Messages.DataType). Ниже представлен пример, иллюстрирующий подписку на отфильтрованный стакан для конкретного инструмента:

1. **Подписка на событие обновления стакана:** [Connector.OrderBookReceived](xref:StockSharp.Algo.Connector.OrderBookReceived) для получения обновлений стакана заявок. Это событие используется как для обычного, так и для отфильтрованного стакана.

    При обработке события, проверьте тип данных [Subscription.DataType](xref:StockSharp.Messages.SubscriptionBase`1.DataType) в объекте `subscription`, связанном с событием. Если [Subscription.DataType](xref:StockSharp.Messages.SubscriptionBase`1.DataType) равно [DataType](xref:StockSharp.Messages.DataType.FilteredMarketDepth), это указывает на то, что полученный стакан является отфильтрованным:

    ```cs
    connector.OrderBookReceived += (sender, subscription, orderBook) =>
    {
        if (subscription.DataType == DataType.FilteredMarketDepth)
        {
            // Логика обработки отфильтрованного стакана заявок
            Console.WriteLine($"Получен отфильтрованный стакан для {orderBook.SecurityId}.");
        }
    };
    ```

2. **Отправка подписки:** Формируем объект [Subscription](xref:StockSharp.BusinessEntities.Subscription) и отправляем их в коннектор:

    ```cs
    var subscription = new Subscription(DataType.FilteredMarketDepth, security);
    connector.Subscribe(subscription);
    
    // или так
    //var subscription = connector.SubscribeFilteredMarketDepth(security);
    ```

## Заключение

Использование отфильтрованного стакана заявок в StockSharp предоставляет трейдерам и разработчикам стратегий гибкий инструмент для анализа рынка, позволяя избегать нежелательного самовзаимодействия между параллельно запущенными стратегиями и упрощая принятие решений на основе данных о рыночных заявках.